---
import Base from "@layouts/Base.astro";
import SectionLayout from "@components/SectionLayout.astro";
import DaysSinceLast from "@components/DaysSinceLast.astro";
import HeatmapGrid from "@components/HeatmapGrid.astro";
import {
  fetchDistanceData,
  processDistanceData,
  getLastActivityDate,
} from "@services/stravaService";

// Fetch and process data
const distanceMap = await fetchDistanceData();
const distanceData = processDistanceData(distanceMap);
const lastRunDate = await getLastActivityDate("Run");

const minDistance = Math.min(...distanceData.map(data => data[1]));
const maxDistance = Math.max(...distanceData.map(data => data[1]));
---

<Base
  title="Strava Matrix Tracker"
  windowTitle="ROOT"
  terminalCommand="./run_activity_monitor.exe"
  systemMessage="[SYSTEM] Loading neural activity patterns... Strava API connected."
>
  <!-- Days Since Last Activity Section -->
  <SectionLayout title="[ACTIVITY_STATUS]">
    <DaysSinceLast lastRunDate={lastRunDate || undefined} activityType="RUN" />
  </SectionLayout>

  <!-- Heatmap Analysis Section -->
  <SectionLayout
    title="[TEMPORAL_ANALYSIS_GRID]"
    rightHeaderText="[365_DAY_NEURAL_MAPPING]"
  >
    <div
      slot="headerElements"
      class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
    >
    </div>
    <div class="heatmap-container">
      <div class="heatmap-wrapper">
        <!-- Heatmap Header Info -->
        <div class="heatmap-info mb-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
            <div class="info-block">
              <span class="text-green-400/60">DATA_RANGE:</span>
              <span class="text-green-300 ml-2">365 DAYS</span>
            </div>
            <div class="info-block">
              <span class="text-green-400/60">MIN_ACTIVITY:</span>
              <span class="text-green-300 ml-2"
                >{minDistance.toFixed(1)} KM</span
              >
            </div>
            <div class="info-block">
              <span class="text-green-400/60">MAX_ACTIVITY:</span>
              <span class="text-green-300 ml-2"
                >{maxDistance.toFixed(1)} KM</span
              >
            </div>
          </div>
        </div>

        <!-- Main Heatmap Grid -->
        <div class="heatmap-display">
          <HeatmapGrid
            distanceData={distanceData}
            minDistance={minDistance}
            maxDistance={maxDistance}
          />
        </div>

        <!-- Heatmap Footer Info with Strava Button -->
        <div class="heatmap-footer mt-4">
          <div class="flex justify-between items-center text-xs">
            <div class="flex items-center space-x-4">
              <span class="text-green-400/60">NEURAL_ACTIVITY_TRACKING</span>
              <div class="flex items-center space-x-1">
                <div class="w-1 h-1 bg-green-500 rounded-full animate-pulse">
                </div>
                <span class="text-green-500">ONLINE</span>
              </div>
            </div>

            <!-- Strava Activities Button -->
            <a
              href="https://www.strava.com/athletes/47698767"
              target="_blank"
              rel="noopener noreferrer"
              class="strava-link-button group"
            >
              <span
                class="text-green-300 hover:text-green-100 transition-colors duration-300 font-mono text-xs flex items-center space-x-2"
              >
                <span>[VERIFY_ON_STRAVA]</span>
                <svg
                  class="w-3 h-3 transition-transform duration-300 group-hover:translate-x-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                  ></path>
                </svg>
              </span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </SectionLayout>
</Base>

<style>
  /* Heatmap Container */
  .heatmap-container {
    background: linear-gradient(
      135deg,
      rgba(0, 0, 0, 0.8) 0%,
      rgba(0, 20, 0, 0.6) 100%
    );
    border: 1px solid rgba(0, 255, 0, 0.3);
    border-radius: 8px;
    padding: 20px;
    box-shadow:
      0 0 20px rgba(0, 255, 0, 0.2),
      inset 0 0 20px rgba(0, 255, 0, 0.05);
    position: relative;
    overflow: hidden;
  }

  .heatmap-container::before {
    content: "";
    position: absolute;
    inset: -1px;
    border-radius: 9px;
    padding: 1px;
    background: linear-gradient(
      45deg,
      rgba(0, 255, 0, 0.4),
      transparent,
      rgba(0, 255, 0, 0.4)
    );
    mask:
      linear-gradient(#fff 0 0) content-box,
      linear-gradient(#fff 0 0);
    mask-composite: xor;
    animation: heatmapBorderGlow 4s ease-in-out infinite;
  }

  @keyframes heatmapBorderGlow {
    0%,
    100% {
      opacity: 0.3;
    }
    50% {
      opacity: 0.8;
    }
  }

  .heatmap-wrapper {
    position: relative;
    z-index: 2;
  }

  .heatmap-display {
    max-width: 1200px;
    margin: 0 auto;
    aspect-ratio: 53/7;
  }

  .heatmap-info,
  .heatmap-footer {
    font-family: "Courier New", monospace;
  }

  .info-block {
    padding: 4px 0;
  }

  /* Strava Link Button */
  .strava-link-button {
    position: relative;
    padding: 6px 12px;
    border: 1px solid rgba(0, 255, 0, 0.3);
    border-radius: 4px;
    background: rgba(0, 255, 0, 0.05);
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .strava-link-button:hover {
    background: rgba(0, 255, 0, 0.1);
    border-color: rgba(0, 255, 0, 0.6);
    box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    transform: translateY(-1px);
  }

  .strava-link-button::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 4px;
    background: linear-gradient(
      45deg,
      transparent,
      rgba(0, 255, 0, 0.1),
      transparent
    );
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .strava-link-button:hover::before {
    opacity: 1;
  }

  /* Diagnostics Section */
  .diagnostics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(0, 255, 0, 0.2);
    border-radius: 6px;
    padding: 16px;
  }

  .diagnostic-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(0, 255, 0, 0.05);
    border: 1px solid rgba(0, 255, 0, 0.1);
    border-radius: 4px;
    font-size: 0.75rem;
  }

  .diagnostic-label {
    color: rgba(0, 255, 0, 0.7);
    font-weight: bold;
  }

  .diagnostic-value {
    font-family: "Courier New", monospace;
    font-weight: bold;
    animation: diagnosticPulse 2s ease-in-out infinite;
  }

  .diagnostic-value.success {
    color: #00ff00;
  }

  .diagnostic-value.warning {
    color: #ffff00;
  }

  .diagnostic-value.error {
    color: #ff4444;
  }

  @keyframes diagnosticPulse {
    0%,
    100% {
      opacity: 0.8;
    }
    50% {
      opacity: 1;
    }
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .heatmap-display {
      max-width: 1000px;
    }
  }

  @media (max-width: 1024px) {
    .heatmap-display {
      max-width: 900px;
    }
  }

  @media (max-width: 768px) {
    .heatmap-container {
      padding: 16px;
    }

    .heatmap-display {
      max-width: 100%;
    }

    .heatmap-info .grid {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .diagnostics-grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .section-header .text-sm {
      font-size: 0.75rem;
    }

    .heatmap-footer {
      flex-direction: column;
      gap: 12px;
      align-items: flex-start;
    }

    .strava-link-button {
      align-self: flex-end;
    }
  }

  @media (max-width: 680px) {
    .heatmap-display {
      aspect-ratio: 26/7;
    }
  }

  @media (max-width: 480px) {
    .heatmap-container {
      padding: 12px;
      margin: 0 -4px;
    }

    .diagnostics-grid {
      padding: 12px;
    }

    .diagnostic-item {
      padding: 6px 8px;
    }

    .strava-link-button span {
      font-size: 0.7rem;
    }
  }
</style>
